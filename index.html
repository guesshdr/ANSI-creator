<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>ANSI Colorizer z Gradientem</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f4f4f4; }
    .controls { display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; }
    .controls label { display: flex; flex-direction: column; font-size: 0.9rem; }
    #preview { white-space: pre-wrap; font-family: monospace; padding: 1rem; background: #fff; min-height: 200px; border: 1px solid #ccc; }
    #raw { width: 100%; height: 200px; font-family: monospace; }
  </style>
</head>
<body>
  <div class="controls">
    <label>Gradient FG start:<input type="color" id="fgStart" value="#f7e3e3"></label>
    <label>Gradient FG end:<input type="color" id="fgEnd" value="#000000"></label>
    <button id="applyGrad">Zastosuj gradient</button>
  </div>
  <div id="preview" contenteditable="true"></div>
  <h3>Raw ANSI output:</h3>
  <textarea id="raw"></textarea>

  <script>
    // helper: convert hex to [r,g,b]
    function hex2rgb(h) {
      let [r,g,b] = h.slice(1).match(/.{2}/g).map(x=>parseInt(x,16)); return [r,g,b];
    }
    // helper: lerp
    function lerp(a,b,t){return a + (b-a)*t;}
    // apply gradient over text nodes
    function applyGradient() {
      const fg1 = hex2rgb(fgStart.value);
      const fg2 = hex2rgb(fgEnd.value);
      const text = preview.innerText;
      preview.innerHTML = '';
      for(let i=0;i<text.length;i++){
        const t = i/(text.length-1||1);
        const r = Math.round(lerp(fg1[0],fg2[0],t));
        const g = Math.round(lerp(fg1[1],fg2[1],t));
        const b = Math.round(lerp(fg1[2],fg2[2],t));
        const span = document.createElement('span');
        span.style.color = `rgb(${r},${g},${b})`;
        span.textContent = text[i];
        preview.append(span);
      }
      syncRaw();
      save();
    }
    // sync raw with ANSI codes from preview
    function syncRaw() {
      let raw = '';
      const spans = preview.querySelectorAll('span');
      if(spans.length>0) {
        spans.forEach(s=>{
          const rgb = window.getComputedStyle(s).color.match(/\d+/g);
          raw += `\x1b[38;2;${rgb[0]};${rgb[1]};${rgb[2]}m${s.textContent}`;
        });
        raw += '\x1b[0m';
      } else {
        raw = preview.innerText;
      }
      rawArea.value = raw;
    }
    function save(){ localStorage.setItem('ansiRaw', rawArea.value); }
    function load(){
      const v = localStorage.getItem('ansiRaw');
      if(v) rawArea.value=v;
      renderRaw();
    }
    function renderRaw(){
      const ansiRe = /\x1b\[([0-9;]+)m/g;
      let m, last=0; preview.innerHTML='';
      while((m=ansiRe.exec(rawArea.value))!==null){
        const codes = m[1].split(';').map(Number);
        // append text before
        appendText(rawArea.value.slice(last, m.index));
        last = ansiRe.lastIndex;
        // parse codes
        if(codes[0]===38 && codes[1]===2) {
          const [r,g,b] = codes.slice(2,5);
          currentColor = `rgb(${r},${g},${b})`;
        } else if(codes[0]===0) {
          currentColor = null;
        }
      }
      appendText(rawArea.value.slice(last));
      function appendText(str){
        for(const ch of str){
          const span = document.createElement('span');
          if(currentColor) span.style.color = currentColor;
          span.textContent = ch;
          preview.append(span);
        }
      }
    }
    const fgStart=document.getElementById('fgStart');
    const fgEnd=document.getElementById('fgEnd');
    const applyGrad=document.getElementById('applyGrad');
    const preview=document.getElementById('preview');
    const rawArea=document.getElementById('raw');
    let currentColor = null;

    applyGrad.addEventListener('click', applyGradient);
    rawArea.addEventListener('input', ()=>{ renderRaw(); save(); });
    preview.addEventListener('input', ()=>{ syncRaw(); save(); });
    window.addEventListener('load', load);
  </script>
</body>
</html>
